generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ユーザー（Admin, Staff, Graduate, Student）
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  role          UserRole
  campus        String?   // 所属校舎
  approved      Boolean   @default(false) // 管理者による承認フラグ

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // リレーション
  graduateStories GraduateStory[]
  favorites       Favorite[]

  @@map("users")
}

enum UserRole {
  SUPER_ADMIN  // 最高管理者（@loohcs.co.jpのみ）
  ADMIN        // 管理者（非推奨、既存データ互換用）
  STAFF        // スタッフ（最高管理者が権限付与）
  USER         // 一般ユーザー
  GRADUATE     // 卒塾生（投稿可能、閲覧不可）
}

// 合格体験記（生徒も閲覧可能）
model GraduateStory {
  id              String    @id @default(uuid())
  authorId        String
  author          User      @relation(fields: [authorId], references: [id])
  authorName      String?   // 投稿者名（投稿時に入力）

  // 基礎属性
  gender          Gender?
  highSchoolLevel HighSchoolLevel
  highSchoolName  String?   // 高校名
  gradeAverage    GradeAverage
  campus          String?   // 所属校舎
  admissionType   String    // 入試方式（総合型選抜、学校推薦型選抜など）
  university      String
  faculty         String
  year            Int?      // 合格年度

  // 探究・活動（多対多）
  explorationThemes StoryExplorationTheme[]
  researchTheme   String?   @db.Text  // 探究テーマ（必須）
  researchMotivation String? @db.Text  // きっかけ（必須）
  researchDetails String?   @db.Text  // 探究活動の詳細（必須）
  targetProfessor String?   @db.Text  // 大学で学びたい教授（必須）

  // 実績
  hasSportsAchievement Boolean @default(false)
  sportsDetails     String?   @db.Text  // 競技名
  sportsAchievements String[] // 実績（複数選択）
  hasEnglishQualification Boolean @default(false)
  englishQualification String?   @db.Text // 英語資格の詳細
  hasStudyAbroad    Boolean   @default(false)
  studyAbroadDetails String?  @db.Text  // 留学先と期間
  hasLeaderExperience Boolean @default(false)
  leaderExperienceDetails String?   @db.Text // リーダー経験の詳細
  hasContestAchievement Boolean @default(false)
  contestAchievementDetails String? @db.Text // コンテスト実績の詳細

  // 選考情報
  interviewQuestions String?  @db.Text

  // 選考フロー（入試方式により異なる）
  firstRoundResult   String?   // 一次選考結果（合格/不合格）
  secondRoundResult  String?   // 二次選考結果（合格/不合格）
  selectionFlowType  String?   // 選考フロータイプ（春AO/夏秋AO/自己推薦入試など）

  // 対策
  documentPreparation    String?   @db.Text  // 書類対策
  secondRoundPreparation String?   @db.Text  // 二次対策
  materials              String?   @db.Text  // 使用教材・参考書

  // 後輩へのアドバイス
  adviceToJuniors   String?   @db.Text

  // 併願校
  concurrentApplications ConcurrentApplication[]

  // 管理者専用フィールド
  status            StoryStatus @default(PENDING_REVIEW) // 承認ステータス
  reviewNotes       String?     @db.Text  // スタッフからの修正依頼メモ
  published         Boolean     @default(false)  // 公開/非公開（statusがPUBLISHEDの時true）
  documentsUrl      String?     // 合格書類URL（管理者/スタッフのみ閲覧可能）

  // リレーション
  favorites         Favorite[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("graduate_stories")
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum HighSchoolLevel {
  LEVEL_1  // 偏差値 ~50
  LEVEL_2  // 偏差値 51-60
  LEVEL_3  // 偏差値 61-70
  LEVEL_4  // 偏差値 71~
}

enum GradeAverage {
  RANGE_1  // ~3.0
  RANGE_2  // 3.1-3.5
  RANGE_3  // 3.6-4.0
  RANGE_4  // 4.1-4.5
  RANGE_5  // 4.6~
}

// 探究テーマ（固定12分類）
model ExplorationTheme {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?

  stories     StoryExplorationTheme[]

  @@map("exploration_themes")
}

// 中間テーブル（合格体験記 ⟷ 探究テーマ）
model StoryExplorationTheme {
  storyId   String
  themeId   Int

  story     GraduateStory     @relation(fields: [storyId], references: [id], onDelete: Cascade)
  theme     ExplorationTheme  @relation(fields: [themeId], references: [id])

  @@id([storyId, themeId])
  @@map("story_exploration_themes")
}

// 併願校
model ConcurrentApplication {
  id          String    @id @default(uuid())
  storyId     String
  story       GraduateStory @relation(fields: [storyId], references: [id], onDelete: Cascade)

  university  String
  faculty     String
  result      ApplicationResult

  @@map("concurrent_applications")
}

enum ApplicationResult {
  ACCEPTED
  REJECTED
  PENDING
}

// 体験記ステータス
enum StoryStatus {
  DRAFT           // 下書き（未使用）
  PENDING_REVIEW  // 承認待ち
  NEEDS_REVISION  // 修正依頼中
  PUBLISHED       // 公開中
}

// お気に入り（ユーザー ⟷ 体験記）
model Favorite {
  id        String   @id @default(uuid())
  userId    String
  storyId   String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  story     GraduateStory  @relation(fields: [storyId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, storyId])
  @@map("favorites")
}